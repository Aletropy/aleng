<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aleng Professional Playground</title>
    <style>
        body { margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; background-color: #1e1e1e; color: #d4d4d4; font-family: 'Segoe UI', sans-serif; }
        header { background-color: #252526; padding: 10px 20px; border-bottom: 1px solid #3e3e3e; display: flex; justify-content: space-between; align-items: center; height: 40px; }
        h1 { margin: 0; font-size: 1rem; font-weight: 600; color: #cccccc; letter-spacing: 0.5px; }

        #main-layout { display: flex; flex: 1; height: calc(100vh - 61px); }
        #editor-container { width: 60%; height: 100%; }
        #terminal-container { width: 40%; height: 100%; background-color: #1e1e1e; border-left: 1px solid #3e3e3e; display: flex; flex-direction: column; }

        #terminal-header { background-color: #252526; padding: 5px 15px; font-size: 0.8rem; text-transform: uppercase; font-weight: bold; color: #858585; border-bottom: 1px solid #3e3e3e; }
        #output { flex: 1; padding: 10px; font-family: 'Consolas', 'Courier New', monospace; font-size: 14px; overflow-y: auto; white-space: pre-wrap; }

        .btn { background-color: #0e639c; color: white; border: none; padding: 6px 14px; cursor: pointer; font-size: 0.85rem; border-radius: 2px; transition: background 0.2s; }
        .btn:hover { background-color: #1177bb; }
        .btn:disabled { background-color: #4d4d4d; cursor: not-allowed; }

        /* Estilos do Terminal */
        .log-info { color: #cccccc; }
        .log-error { color: #f48771; margin-top: 5px; display: block; }
        .log-success { color: #89d185; font-weight: bold; }
        .log-system { color: #4ec9b0; font-style: italic; opacity: 0.7; font-size: 0.9em; }
    </style>
</head>
<body>

<header>
    <h1>ALENG PLAYGROUND</h1>
    <button id="runBtn" class="btn" disabled>Initializing...</button>
</header>

<div id="main-layout">
    <div id="editor-container"></div>
    <div id="terminal-container">
        <div id="terminal-header">Terminal Output</div>
        <div id="output"></div>
    </div>
</div>

<!-- Carregador do Monaco Editor -->
<script src="https://unpkg.com/monaco-editor@0.44.0/min/vs/loader.js"></script>
<!-- Binário da Aleng -->
<script src="AlengWasm.js"></script>

<script>
    let alengInstance = null;
    let editor = null;
    const outputDiv = document.getElementById('output');
    const runBtn = document.getElementById('runBtn');

    require.config({ paths: { 'vs': 'https://unpkg.com/monaco-editor@0.44.0/min/vs' }});

    require(['vs/editor/editor.main'], function() {
        monaco.languages.register({ id: 'aleng' });

        monaco.languages.setMonarchTokensProvider('aleng', {
            tokenizer: {
                root: [
                    [/\b(If|Else|While|For|Fn|Return|Break|Continue|Module|Import|End|in|step|until)\b/, "keyword"],
                    [/\b(True|False)\b/, "keyword.constant"],

                    [/[a-zA-Z_]\w*/, "identifier"],

                    [/"([^"\\]|\\.)*$/, "string.invalid"],
                    [/"/,  { token: "string.quote", bracket: "@open", next: "@string" } ],

                    [/\d+(\.\d+)?/, "number"],

                    [/#.*$/, "comment"],
                ],
                string: [
                    [/[^\\"]+/,  "string"],
                    [/\\./,      "string.escape"],
                    [/"/,        { token: "string.quote", bracket: "@close", next: "@pop" } ]
                ]
            }
        });

        editor = monaco.editor.create(document.getElementById('editor-container'), {
            value: [
                '# Bem-vindo ao Aleng Playground',
                'Fn fibonacci(n)',
                '    If n <= 1',
                '        Return n',
                '    End',
                '    Return fibonacci(n - 1) + fibonacci(n - 2)',
                'End',
                '',
                'Print("Calculando sequência...")',
                'For i = 0 .. 10',
                '    val = fibonacci(i)',
                '    Print("Fib(" + i + ") = " + val)',
                'End'
            ].join('\n'),
            language: 'aleng',
            theme: 'vs-dark',
            fontSize: 14,
            minimap: { enabled: false },
            scrollBeyondLastLine: false,
            automaticLayout: true
        });
    });

    function log(text, type = 'info') {
        const span = document.createElement('div');
        span.innerText = text;
        if (type === 'error') span.className = 'log-error';
        else if (type === 'system') span.className = 'log-system';
        else if (type === 'success') span.className = 'log-success';
        else span.className = 'log-info';

        outputDiv.appendChild(span);
        outputDiv.scrollTop = outputDiv.scrollHeight;
    }

    const ModuleConfig = {
        print: (text) => log(text, 'info'),
        printErr: (text) => console.error(text)
    };

    createAlengModule(ModuleConfig).then(instance => {
        log("• System Ready: Aleng VM Loaded", 'system');
        try {
            alengInstance = new instance.Aleng();
            runBtn.disabled = false;
            runBtn.textContent = "RUN CODE ▶";
        } catch (e) {
            log("Fatal: Failed to instantiate VM: " + e, 'error');
        }
    });

    runBtn.addEventListener('click', () => {
        if (!alengInstance || !editor) return;

        outputDiv.innerHTML = '';
        log("• Compiling & Running...", 'system');

        const source = editor.getValue();

        try {
            setTimeout(() => {
                const result = alengInstance.execute(source);

                if (result.startsWith("Runtime Error")) {
                    log(result, 'error');
                    const match = result.match(/line (\d+)/);
                    if (match) highlightError(parseInt(match[1]), result);
                }
                else if (result.startsWith("Fatal Error")) {
                    log(result, 'error');
                }
                else {
                    log("\n• Process finished successfully.", 'success');
                }
            }, 10);

        } catch (e) {
            log("JS Interface Error: " + e, 'error');
        }
    });

    function highlightError(line, msg) {
        const model = editor.getModel();
        monaco.editor.setModelMarkers(model, "owner", [{
            startLineNumber: line,
            startColumn: 1,
            endLineNumber: line,
            endColumn: model.getLineContent(line).length + 1,
            message: msg,
            severity: monaco.MarkerSeverity.Error
        }]);
    }
</script>
</body>
</html>